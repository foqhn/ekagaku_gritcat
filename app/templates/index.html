<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>ROS 2 FastAPI Viewer</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>
    <h1>ROS 2 Real-time Data Viewer</h1>

    <h2>IMU Data (/bno055/imu)</h2>
    <pre id="imu-data">Connecting...</pre>

    <h2>Camera Image (/camera/image_raw)</h2>
    <img id="camera-image" width="640" height="480" alt="Camera stream will appear here">
    <h2>Control Commands</h2>
    <div id="controls">
        <div>
            <label for="speed-slider">Speed: <span id="speed-value">10</span></label>
            <input type="range" id="speed-slider" min="0" max="100" value="10">
        </div>
        <div class="buttons">
            <button id="forward">Forward</button>
            <button id="backward">Backward</button>
            <button id="left">Turn Left</button>
            <button id="right">Turn Right</button>
            <button id="stop">Stop</button>
        </div>
    </div>
    <script>
        // IMU WebSocket
        const imu_ws = new WebSocket(`ws://${window.location.host}/sensors/imu`);
        imu_ws.onmessage = function (event) {
            const data = JSON.parse(event.data);
            document.getElementById('imu-data').textContent = JSON.stringify(data, null, 2);
        };
        imu_ws.onclose = function (event) {
            document.getElementById('imu-data').textContent = 'Connection closed.';
        };

        // Image WebSocket
        const image_ws = new WebSocket(`ws://${window.location.host}/sensors/image`);
        image_ws.binaryType = "blob";
        const imageElement = document.getElementById('camera-image');

        image_ws.onmessage = function (event) {
            if (typeof event.data === 'string') return; // heartbeat
            const url = URL.createObjectURL(event.data);
            imageElement.src = url;
            imageElement.onload = () => URL.revokeObjectURL(url);
        };
        image_ws.onclose = function (event) {
            console.log('Image WebSocket connection closed.');
        };

        // Control WebSocket
        const controlSocket = new WebSocket("ws://" + window.location.host + "/control");

        controlSocket.onopen = () => console.log("Control WebSocket connected!");
        controlSocket.onerror = (error) => console.log("WebSocket error: ", error);
        controlSocket.onclose = () => console.log("Control WebSocket disconnected.");

        // スライダーと表示を初期化
        const speedSlider = document.getElementById('speed-slider');
        const speedValue = document.getElementById('speed-value');
        speedSlider.addEventListener('input', () => {
            speedValue.textContent = speedSlider.value;
        });

        // 命令を送信する関数（現在のスピード値を含める）
        function sendCommand(command) {
            if (controlSocket.readyState === WebSocket.OPEN) {
                const speed = parseInt(speedSlider.value, 10);
                const dataObj = { "command": command, "speed": speed };
                const data = JSON.stringify(dataObj);
                controlSocket.send(data);
                console.log("Sent:", data);
            } else {
                console.warn('Control socket not open. ReadyState:', controlSocket.readyState);
            }
        }

        // 各ボタンにクリックイベントを割り当て
        document.getElementById("forward").onclick = () => sendCommand("forward");
        document.getElementById("stop").onclick = () => sendCommand("stop");
        document.getElementById("left").onclick = () => sendCommand("turn_left");
        document.getElementById("right").onclick = () => sendCommand("turn_right");
    </script>
</body>

</html>